/**
 * skylark-online3dviewer - A version of online3dviewer that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-online3dviewer/
 * @license MIT
 */
define(["skylark-jquery","skylark-jsmodeler","./InfoTable","./FloatingControl","./FloatingDialog","./ExtensionInterface","./ExtensionButtons","./ImporterProgressBar","./ImporterButtons","./ImporterMenu","./ImporterViewer"],function(e,t,i,n,s,o,r,a,l,h,d){var u=function(){this.canvas=null,this.viewer=null,this.fileNames=null,this.inGenerate=!1,this.meshesGroup=null,this.materialMenuItems=null,this.meshMenuItems=null,this.extensions=[],this.importerButtons=null,this.extensionButtons=null,this.introControl=null,this.floatingDialog=null,this.isMobile=null,this.readyForTest=null};return u.prototype.Init=function(){if(t.IsWebGLEnabled()&&t.IsFileApiEnabled()){var i=this,o=e("#top");this.importerButtons=new l(o),this.importerButtons.AddLogo('Online 3D Viewer <span class="version">v 0.6.6</span>'),this.importerButtons.AddButton("images/openfile.png","Open File",function(){i.OpenFile()}),this.importerButtons.AddButton("images/fitinwindow.png","Fit In Window",function(){i.FitInWindow()}),this.importerButtons.AddToggleButton("images/fixup.png","images/fixupgray.png","Enable/Disable Fixed Up Vector",function(){i.SetFixUp()}),this.importerButtons.AddButton("images/top.png","Set Up Vector (Z)",function(){i.SetNamedView("z")}),this.importerButtons.AddButton("images/bottom.png","Set Up Vector (-Z)",function(){i.SetNamedView("-z")}),this.importerButtons.AddButton("images/front.png","Set Up Vector (Y)",function(){i.SetNamedView("y")}),this.importerButtons.AddButton("images/back.png","Set Up Vector (-Y)",function(){i.SetNamedView("-y")}),this.importerButtons.AddButton("images/left.png","Set Up Vector (X)",function(){i.SetNamedView("x")}),this.importerButtons.AddButton("images/right.png","Set Up Vector (-X)",function(){i.SetNamedView("-x")}),this.extensionButtons=new r(o),this.introControl=new n,this.floatingDialog=new s;var a=window.matchMedia("(max-device-width : 600px)");this.isMobile=a.matches,window.addEventListener("resize",this.Resize.bind(this),!1),this.Resize();this.canvas=e("#modelcanvas"),this.RegisterCanvasClick(),this.viewer=new d,this.viewer.Init("modelcanvas"),window.addEventListener("dragover",this.DragOver.bind(this),!1),window.addEventListener("drop",this.Drop.bind(this),!1),document.getElementById("file").addEventListener("change",this.FileSelected.bind(this),!1),window.onhashchange=this.LoadFilesFromHash.bind(this),this.LoadFilesFromHash()||this.isMobile||this.ShowIntroControl()}else{for(;document.body.lastChild;)document.body.removeChild(document.body.lastChild);e("<div>").addClass("nosupport").appendTo(e("body")).html(['<div id="nosupport">',this.GetWelcomeText(),'<div class="nosupporterror">You need a browser which supports the following technologies: WebGL, WebGLRenderingContext, File, FileReader, FileList, Blob, URL.</div>',"</div>"].join(""))}},u.prototype.ClearReadyForTest=function(){null!==this.readyForTest&&(this.readyForTest.remove(),this.readyForTest=null)},u.prototype.SetReadyForTest=function(){this.readyForTest=e("<div>").attr("id","readyfortest").hide().appendTo(e("body"))},u.prototype.AddExtension=function(e){if(e.IsEnabled()){var t=new o(this);e.Init(t)}},u.prototype.ShowIntroControl=function(){var e=['<div class="importerdialog">',this.GetWelcomeText(),"</div>"].join("");this.introControl.Open({parent:this.canvas,text:e}),this.Resize()},u.prototype.HideIntroControl=function(){this.introControl.Close(),this.Resize()},u.prototype.GetWelcomeText=function(){return['<div class="welcometitle">Welcome to Online 3D Viewer!</div>','<div class="welcometext">Here you can view your local 3D models online. You have three ways to open a file. Use the open button above to select files, simply drag and drop files to this browser window, or define the url of the files as location hash.</div>','<div class="welcometextformats">Supported formats: 3ds, obj, stl, off.</div>','<div class="welcometext">Powered by <a target="_blank" href="https://github.com/mrdoob/three.js/">Three.js</a> and <a target="_blank" href="https://github.com/kovacsv/JSModeler">JSModeler</a>.</div>','<div class="welcometext"><a target="_blank" href="https://github.com/kovacsv/Online3DViewer"><img src="images/githublogo.png"/></a></div>'].join("")},u.prototype.Resize=function(){function e(e,t){e.height=t,e.style.height=t+"px"}var t,i,n=document.getElementById("top"),s=document.getElementById("left"),o=document.getElementById("modelcanvas"),r=document.body.clientHeight-n.offsetHeight;e(s,r),e(o,r),t=o,i=document.body.clientWidth-s.offsetWidth,t.width=i,t.style.width=i+"px",this.introControl.Resize(),this.floatingDialog.Resize()},u.prototype.JsonLoaded=function(e){this.Generate(e)},u.prototype.GenerateMenu=function(){function n(e,t,i){return e.AddGroup(t,{id:i,openCloseButton:{title:"Show/Hide "+t}})}function s(t,n,s,o,r){return s.AddSubItem(r.name,{openCloseButton:{title:"Show/Hide Information",onOpen:function(n,s){n.empty();var r=e("<div>").addClass("submenubuttons").appendTo(n);e("<img>").addClass("submenubutton").attr("src","images/highlightmesh.png").attr("title","Highlight Meshes By Material").appendTo(r).click(function(){t.HighlightMeshesByMaterial(o)}),e("<img>").addClass("submenubutton").attr("src","images/fitinwindowsmall.png").attr("title","Fit Meshes In Window By Material").appendTo(r).click(function(){t.FitMeshesByMaterialInWindow(o)});var a=new i(n);a.AddColorRow("Ambient",s.ambient),a.AddColorRow("Diffuse",s.diffuse),a.AddColorRow("Specular",s.specular),a.AddRow("Shininess",s.shininess.toFixed(2)),a.AddRow("Opacity",s.opacity.toFixed(2))},userData:r}})}function o(n,s,o,r,a){function l(t,i,n,s){var o=e("<div>").addClass("submenubuttons").appendTo(i);e("<img>").addClass("submenubutton").attr("src","images/fitinwindowsmall.png").attr("title","Fit Mesh In Window").appendTo(o).click(function(){t.FitMeshInWindow(s)}),e("<img>").addClass("submenubutton").attr("src","images/highlightmesh.png").attr("title","Highlight Mesh").appendTo(o).click(function(){t.HighlightMesh(s)}),e("<img>").addClass("submenubutton").attr("src","images/copytoclipboard.png").attr("title","Copy Mesh Name To Clipboard").appendTo(o).click(function(){var e,t;e=n,(t=document.createElement("input")).style.position="absolute",t.style.left="0",t.style.top="0",t.setAttribute("value",e),document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)})}var h=null,d=o.AddSubItem(r.name,{id:"meshmenuitem-"+a.toString(),openCloseButton:{title:"Show/Hide Details",onOpen:function(e,s){e.empty(),l(n,e,s.name,a);var o,r,h=new i(e),d=new t.Coord(t.Inf,t.Inf,t.Inf),u=new t.Coord(-t.Inf,-t.Inf,-t.Inf);for(o=0;o<s.vertices.length;o+=3)r=new t.Coord(s.vertices[o],s.vertices[o+1],s.vertices[o+2]),d.x=t.Minimum(d.x,r.x),d.y=t.Minimum(d.y,r.y),d.z=t.Minimum(d.z,r.z),u.x=t.Maximum(u.x,r.x),u.y=t.Maximum(u.y,r.y),u.z=t.Maximum(u.z,r.z);h.AddRow("X Size",(u.x-d.x).toFixed(2)),h.AddRow("Y Size",(u.y-d.y).toFixed(2)),h.AddRow("Z Size",(u.z-d.z).toFixed(2));var m=0;for(o=0;o<s.triangles.length;o++)m+=s.triangles[o].parameters.length/9;h.AddRow("Vertex count",s.vertices.length/3),h.AddRow("Triangle count",m)},userData:r},userButtons:[{id:"showhidemesh-"+a,title:"Show/Hide Mesh",onCreate:function(e){e.attr("src","images/visible.png"),h=e},onClick:function(e,t){n.ShowHideMesh(t)},onCtrlClick:function(e,t){n.IsolateMesh(t)},userData:a}]});return d.isVisible=!0,d.visibleImage=h,d}var r,a=this.viewer.GetJsonData(),l=e("#menu"),d=new h(l),u=n(d,"Files","filesmenuitem");for(u.AddSubItem(this.fileNames.main),r=0;r<this.fileNames.requested.length;r++)u.AddSubItem(this.fileNames.requested[r]);if(this.fileNames.missing.length>0){var m=n(d,"Missing Files","missingfilesmenuitem");for(r=0;r<this.fileNames.missing.length;r++)m.AddSubItem(this.fileNames.missing[r])}!function(e,t){var n,s,o,r=new i(e.GetContentDiv()),a=t.materials.length,l=0,h=0;for(n=0;n<t.meshes.length;n++)for(l+=(o=t.meshes[n]).vertices.length/3,s=0;s<o.triangles.length;s++)h+=o.triangles[s].parameters.length/9;r.AddRow("Material count",a),r.AddRow("Vertex count",l),r.AddRow("Triangle count",h)}(n(d,"Information","informationmenuitem"),a),this.materialMenuItems=[];var p,c,g,f=n(d,"Materials","materialsmenuitem");for(r=0;r<a.materials.length;r++)p=s(this,0,f,r,a.materials[r]),this.materialMenuItems.push(p);for(this.meshesGroup=n(d,"Meshes","meshesmenuitem"),this.meshMenuItems=[],r=0;r<a.meshes.length;r++)c=a.meshes[r],g=o(this,0,this.meshesGroup,c,r),this.meshMenuItems.push(g);this.Resize()},u.prototype.GenerateError=function(t){this.viewer.RemoveMeshes(),e("#menu").empty(),this.floatingDialog.Open({title:"Error",text:'<div class="importerdialog">'+t+"</div>",buttons:[{text:"ok",callback:function(e){e.Close()}}]})},u.prototype.Generate=function(e){function i(e,i,n){e.inGenerate=!0;var s={onStart:function(e){i.Init(e)},onProgress:function(e){i.Step(e+1)},onFinish:function(){e.GenerateMenu(),e.inGenerate=!1,e.SetReadyForTest()}};if(n){var o=e.viewer.GetJsonData();e.viewer.SetJsonData(t.MergeJsonDataMeshes(o))}e.viewer.ShowAllMeshes(s)}var n=this.viewer.GetJsonData();if(0===n.materials.length||0===n.meshes.length)return this.GenerateError("Failed to open file. Maybe something is wrong with your file."),void this.SetReadyForTest();var s=this;n.meshes.length>250?this.floatingDialog.Open({title:"Information",text:'<div class="importerdialog">The model contains a large number of meshes. It can cause performance problems. Would you like to merge meshes?</div>',buttons:[{text:"yes",callback:function(t){i(s,e,!0),t.Close()}},{text:"no",callback:function(t){i(s,e,!1),t.Close()}}]}):i(s,e,!1)},u.prototype.FitInWindow=function(){this.viewer.FitInWindow()},u.prototype.FitMeshInWindow=function(e){this.viewer.FitMeshInWindow(e)},u.prototype.FitMeshesByMaterialInWindow=function(e){var t=this.viewer.GetMeshesByMaterial(e);0!==t.length&&this.viewer.FitMeshesInWindow(t)},u.prototype.SetFixUp=function(){this.viewer.SetFixUp()},u.prototype.SetNamedView=function(e){this.viewer.SetNamedView(e)},u.prototype.SetView=function(e){this.viewer.SetView(e)},u.prototype.ShowHideMesh=function(e){var t=this.meshMenuItems[e];this.ShowHideMeshInternal(e,!t.isVisible),this.viewer.Draw()},u.prototype.IsolateMesh=function(e){var t,i=!0;if(this.meshMenuItems[e].isVisible){for(t=0;t<this.meshMenuItems.length;t++)if(this.meshMenuItems[t].isVisible&&t!==e){i=!1;break}}else i=!1;for(t=0;t<this.meshMenuItems.length;t++)i?this.ShowHideMeshInternal(t,!0):t==e?this.ShowHideMeshInternal(t,!0):this.ShowHideMeshInternal(t,!1);this.viewer.Draw()},u.prototype.ShowHideMeshInternal=function(e,t){var i=this.meshMenuItems[e];i.isVisible=t,i.visibleImage.attr("src",i.isVisible?"images/visible.png":"images/hidden.png"),this.viewer.ShowMesh(e,i.isVisible)},u.prototype.HighlightMeshInternal=function(e,t){this.meshMenuItems[e].Highlight(t),this.viewer.HighlightMesh(e,t)},u.prototype.ProcessFiles=function(i,n){if(this.ClearReadyForTest(),this.HideIntroControl(),this.floatingDialog.Close(),!this.inGenerate){var s=i;if(0!==s.length){this.fileNames=null;var o=this,r=t.ConvertFileListToJsonData;n&&(r=t.ConvertURLListToJsonData);var l=e("#menu");l.empty(),n?l.html("Downloading files..."):l.html("Loading files..."),r(s,{onError:function(){o.GenerateError("No readable file found. You can open 3ds, obj, stl, and off files."),o.SetReadyForTest()},onReady:function(e,t){o.fileNames=e,o.viewer.SetJsonData(t),l.empty();var i=new a(l);o.JsonLoaded(i)}})}}},u.prototype.RegisterCanvasClick=function(){var t=this,i=null;this.canvas.mousedown(function(){i=[event.pageX,event.pageY]}),this.canvas.mouseup(function(n){if(!(null==i||n.pageX!=i[0]||n.pageY!=i[1])){var s=n.pageX-e(this).offset().left,o=n.pageY-e(this).offset().top;t.OnCanvasClick(s,o)}i=null})},u.prototype.ScrollMeshIntoView=function(e){-1!=e&&this.meshMenuItems[e].menuItemDiv.get(0).scrollIntoView()},u.prototype.HighlightMesh=function(e){var t,i;if(-1!=e)for(t=0;t<this.meshMenuItems.length;t++)i=this.meshMenuItems[t],!1,t==e&&(i.IsHighlighted()?this.HighlightMeshInternal(t,!1):this.HighlightMeshInternal(t,!0));else for(t=0;t<this.meshMenuItems.length;t++)(i=this.meshMenuItems[t]).IsHighlighted()&&this.HighlightMeshInternal(t,!1);this.viewer.Draw()},u.prototype.HighlightMeshesByMaterial=function(e){var t=this.viewer.GetMeshesByMaterial(e);if(0!==t.length){var i,n;for(this.HighlightMesh(-1),i=0;i<t.length;i++)n=t[i],this.meshMenuItems[n],this.HighlightMeshInternal(n,!0);this.meshesGroup.SetOpen(!0),this.ScrollMeshIntoView(t[0]),this.viewer.Draw()}},u.prototype.OnCanvasClick=function(e,t){if(null!=this.meshMenuItems){var i=this.viewer.GetMeshesUnderPosition(e,t),n=-1;i.length>0&&(n=i[0].originalJsonMeshIndex,this.meshesGroup.SetOpen(!0)),this.HighlightMesh(n),this.ScrollMeshIntoView(n)}},u.prototype.DragOver=function(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"},u.prototype.Drop=function(e){e.stopPropagation(),e.preventDefault(),this.ResetHash(),this.ProcessFiles(e.dataTransfer.files,!1)},u.prototype.FileSelected=function(e){e.stopPropagation(),e.preventDefault(),this.ResetHash(),this.ProcessFiles(e.target.files,!1)},u.prototype.OpenFile=function(){document.getElementById("file").click()},u.prototype.ResetHash=function(){window.location.hash.length>1&&(window.location.hash="")},u.prototype.LoadFilesFromHash=function(){if(window.location.hash.length<2)return!1;var t=e("#file");if("#testmode"==(i=window.location.hash))return t.css("display",""),t.css("position","absolute"),t.css("right","10px"),t.css("bottom","10px"),!1;t.css("display","none");var i,n=(i=i.substr(1,i.length-1)).split(",");return this.ProcessFiles(n,!0),!0},u});
//# sourceMappingURL=sourcemaps/ImporterApp.js.map
